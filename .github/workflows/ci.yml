# =============================================================================
# KafkasDer CI/CD Pipeline
# =============================================================================
# Bu workflow, pull request ve main branch push'larÄ±nda otomatik olarak Ã§alÄ±ÅŸÄ±r
# Lint, type-check, test ve build aÅŸamalarÄ±nÄ± iÃ§erir
# =============================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch: # Manuel tetikleme iÃ§in

# AynÄ± branch'teki Ã¶nceki workflow'larÄ± iptal et
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # =============================================================================
  # 1. Lint & Type Check
  # =============================================================================
  lint:
    name: ðŸ” Lint & Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ” ESLint
        run: pnpm lint
        continue-on-error: false

      - name: ðŸ“ Type Check
        run: pnpm type-check

  # =============================================================================
  # 2. Unit Tests
  # =============================================================================
  test:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: lint

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ§ª Run Tests
        run: pnpm test:run

      - name: ðŸ“Š Upload Coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          fail_ci_if_error: false

  # =============================================================================
  # 3. Build
  # =============================================================================
  build:
    name: ðŸ—ï¸ Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint, test]

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ Build Application
        run: pnpm build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.NEXT_PUBLIC_SENTRY_DSN }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}

      - name: ðŸ“¦ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: .next
          retention-days: 7

  # =============================================================================
  # 4. Security Scan
  # =============================================================================
  security:
    name: ðŸ” Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: lint

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ” Audit dependencies
        run: pnpm audit --audit-level=high
        continue-on-error: true

  # =============================================================================
  # 5. Deploy to Render (Production)
  # =============================================================================
  deploy-production:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [build, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://kafkasder-panel.onrender.com

    steps:
      - name: ðŸš€ Trigger Render Deploy
        run: |
          curl -X POST "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}'
        continue-on-error: false

      - name: ðŸ“¢ Notify Sentry of Deploy
        run: |
          curl -X POST "https://sentry.io/api/0/organizations/${{ secrets.SENTRY_ORG }}/releases/" \
            -H "Authorization: Bearer ${{ secrets.SENTRY_AUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "version": "${{ github.sha }}",
              "projects": ["${{ secrets.SENTRY_PROJECT }}"],
              "refs": [{
                "repository": "${{ github.repository }}",
                "commit": "${{ github.sha }}"
              }]
            }'
        continue-on-error: true

  # =============================================================================
  # 6. Deploy Preview (Pull Requests)
  # =============================================================================
  deploy-preview:
    name: ðŸ” Deploy Preview
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build
    if: github.event_name == 'pull_request'

    steps:
      - name: ðŸ“¢ Comment PR with Preview Link
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const message = `## ðŸ” Preview Deployment

            Preview environment is being deployed by Render.

            **Status**: â³ Deploying...

            The preview URL will be available once Render finishes building.
            Check the [Render Dashboard](https://dashboard.render.com) for status.

            ---
            *Commit: ${context.sha.substring(0, 7)}*`;

            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

  # =============================================================================
  # 7. Notify on Failure
  # =============================================================================
  notify-failure:
    name: ðŸ“¢ Notify on Failure
    runs-on: ubuntu-latest
    needs: [lint, test, build, security]
    if: failure()

    steps:
      - name: ðŸ“¢ Create Issue on Failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ CI/CD Pipeline Failed: ${context.workflow}`;
            const body = `## CI/CD Pipeline Failure

            **Workflow**: ${context.workflow}
            **Run ID**: ${context.runId}
            **Commit**: ${context.sha}
            **Branch**: ${context.ref}
            **Actor**: @${context.actor}

            [View Workflow Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            ---
            *Auto-generated by GitHub Actions*`;

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure'
            });

            const existingIssue = issues.data.find(i => i.title.includes('CI/CD Pipeline Failed'));

            if (!existingIssue) {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['ci-failure', 'bug']
              });
            }

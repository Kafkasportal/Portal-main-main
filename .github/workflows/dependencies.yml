# =============================================================================
# KafkasDer Dependency Update Workflow
# =============================================================================
# HaftalÄ±k olarak dependency gÃ¼ncellemelerini kontrol eder
# =============================================================================

name: Dependency Updates

on:
  schedule:
    - cron: '0 9 * * 1' # Her Pazartesi 09:00 UTC
  workflow_dispatch:

jobs:
  update:
    name: ðŸ“¦ Check Updates
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '9'

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ” Check for Updates
        id: updates
        run: |
          echo "## ðŸ“¦ Dependency Update Report" > update-report.md
          echo "" >> update-report.md
          echo "Generated: $(date)" >> update-report.md
          echo "" >> update-report.md
          pnpm outdated --format json > outdated.json || true
          if [ -s outdated.json ]; then
            echo "### Outdated Packages" >> update-report.md
            echo '```json' >> update-report.md
            cat outdated.json >> update-report.md
            echo '```' >> update-report.md
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… All dependencies are up to date!" >> update-report.md
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¤ Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: update-report.md
          retention-days: 30

      - name: ðŸ“¢ Create Issue for Updates
        if: steps.updates.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('update-report.md', 'utf8');
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dependencies'
            });
            
            const existingIssue = issues.data.find(i => i.title.includes('Weekly Dependency Update'));
            
            const title = `ðŸ“¦ Weekly Dependency Update - ${new Date().toISOString().split('T')[0]}`;
            const body = `${report}\n\n---\n*Auto-generated by GitHub Actions*`;
            
            if (existingIssue) {
              github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
            } else {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['dependencies', 'maintenance']
              });
            }

# ğŸš€ Render.com Deployment ve YÃ¶netim

Bu dokÃ¼man, KafkasDer YÃ¶netim Paneli'ni Render.com'a deploy etme, MCP entegrasyonu ve webhook yapÄ±landÄ±rmasÄ±nÄ± aÃ§Ä±klar.

## ğŸ“‹ Ä°Ã§indekiler

1. [Ã–n Gereksinimler](#Ã¶n-gereksinimler)
2. [Render Blueprint KullanÄ±mÄ±](#render-blueprint-kullanÄ±mÄ±)
3. [Manuel Deployment](#manuel-deployment)
4. [Environment Variables](#environment-variables)
5. [Custom Domain](#custom-domain)
6. [Render MCP Server](#render-mcp-server)
7. [Webhook YapÄ±landÄ±rmasÄ±](#webhook-yapÄ±landÄ±rmasÄ±)
8. [Monitoring ve Logging](#monitoring-ve-logging)
9. [Sorun Giderme](#sorun-giderme)

---

## âœ… Ã–n Gereksinimler

1. **Render.com HesabÄ±:**
   - [Render.com](https://render.com) Ã¼zerinde hesap oluÅŸturun
   - GitHub/GitLab hesabÄ±nÄ±zÄ± baÄŸlayÄ±n

2. **Supabase Projesi:**
   - Supabase projeniz hazÄ±r olmalÄ±
   - Database migration'larÄ± tamamlanmÄ±ÅŸ olmalÄ±
   - Detaylar iÃ§in [SUPABASE.md](./SUPABASE.md) dosyasÄ±na bakÄ±n

3. **Git Repository:**
   - Kod GitHub/GitLab'da olmalÄ±
   - `render.yaml` dosyasÄ± root dizinde olmalÄ±

---

## ğŸ“¦ Render Blueprint KullanÄ±mÄ±

### AdÄ±m 1: Blueprint DosyasÄ±nÄ± Kontrol Edin

`render.yaml` dosyasÄ± proje root'unda mevcut. Bu dosya Infrastructure as Code (IaC) yaklaÅŸÄ±mÄ±yla tÃ¼m servisleri tanÄ±mlar.

### AdÄ±m 2: Render Dashboard'da Blueprint OluÅŸtur

1. [Render Dashboard](https://dashboard.render.com) â†’ **New** â†’ **Blueprint**
2. Repository'yi seÃ§in: `Kafkasportal/Portal`
3. **Apply** butonuna tÄ±klayÄ±n

### AdÄ±m 3: Environment Variables AyarlayÄ±n

Render, `sync: false` olan environment variable'lar iÃ§in sizden deÄŸer isteyecek:

**Zorunlu DeÄŸiÅŸkenler:**
- `NEXT_PUBLIC_APP_URL` - Production URL (Ã¶rn: `https://panel.kafkasder.org`)
- `NEXT_PUBLIC_SUPABASE_URL` - Supabase project URL
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` - Supabase anon key
- `SUPABASE_SERVICE_ROLE_KEY` - Supabase service role key (gizli)

**Opsiyonel DeÄŸiÅŸkenler:**
- `NEXT_PUBLIC_API_URL` - EÄŸer ayrÄ± bir API varsa
- `NEXT_PUBLIC_GA_ID` - Google Analytics ID
- `NEXT_PUBLIC_SENTRY_DSN` - Sentry error tracking
- `RENDER_WEBHOOK_SECRET` - Webhook gÃ¼venlik secret'Ä±

### AdÄ±m 4: Deploy

Render otomatik olarak:
1. Repository'yi clone eder
2. `npm ci && npm run build` komutunu Ã§alÄ±ÅŸtÄ±rÄ±r
3. `npm run db:migrate` komutunu Ã§alÄ±ÅŸtÄ±rÄ±r (pre-deploy)
4. `npm start` komutu ile servisi baÅŸlatÄ±r

---

## ğŸ”§ Manuel Deployment

EÄŸer Blueprint kullanmak istemiyorsanÄ±z:

### AdÄ±m 1: Yeni Web Service OluÅŸtur

1. Render Dashboard â†’ **New** â†’ **Web Service**
2. Repository'yi baÄŸlayÄ±n
3. AyarlarÄ± yapÄ±landÄ±rÄ±n:

**Build Settings:**
- **Build Command:** `npm ci && npm run build`
- **Start Command:** `npm start`

**Advanced Settings:**
- **Pre-deploy Command:** `npm run db:migrate || true`
- **Health Check Path:** `/`
- **Auto-deploy:** `Yes` (veya `Only on merge to main`)

### AdÄ±m 2: Environment Variables Ekle

Manuel olarak tÃ¼m environment variable'larÄ± ekleyin (yukarÄ±daki listeye bakÄ±n).

---

## ğŸ” Environment Variables

### Production Environment Variables

```env
# Application
NODE_ENV=production
NEXT_PUBLIC_APP_NAME=KafkasDer YÃ¶netim Paneli
NEXT_PUBLIC_APP_URL=https://panel.kafkasder.org

# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# API
NEXT_PUBLIC_API_URL=https://api.kafkasder.org
NEXT_PUBLIC_API_TIMEOUT=30000
NEXT_PUBLIC_USE_MOCK_API=false

# Auth
NEXT_PUBLIC_AUTH_COOKIE_NAME=kafkasder-auth
NEXT_PUBLIC_AUTH_COOKIE_EXPIRES=7d

# Features
NEXT_PUBLIC_ENABLE_QR_SCANNER=true
NEXT_PUBLIC_ENABLE_EXCEL_EXPORT=true
NEXT_PUBLIC_ENABLE_DEVTOOLS=false

# Webhook
RENDER_WEBHOOK_SECRET=<auto-generated>
```

### Environment Variable'larÄ± Render'da Ayarlama

1. Service â†’ **Environment** sekmesi
2. **Add Environment Variable** butonuna tÄ±klayÄ±n
3. Key ve Value'yu girin
4. **Save Changes** butonuna tÄ±klayÄ±n

**âš ï¸ Ã–nemli:** `SUPABASE_SERVICE_ROLE_KEY` gibi gizli bilgileri asla commit etmeyin!

---

## ğŸŒ Custom Domain

### AdÄ±m 1: Domain'i Render'a Ekle

1. Service â†’ **Settings** â†’ **Custom Domains**
2. **Add Custom Domain** butonuna tÄ±klayÄ±n
3. Domain adÄ±nÄ± girin (Ã¶rn: `panel.kafkasder.org`)

### AdÄ±m 2: DNS AyarlarÄ±

Render size DNS kayÄ±tlarÄ± verecek. Domain saÄŸlayÄ±cÄ±nÄ±zda ÅŸu kayÄ±tlarÄ± ekleyin:

**CNAME KaydÄ±:**
```
Type: CNAME
Name: panel (veya www)
Value: <render-service-url>.onrender.com
TTL: 3600
```

**A KaydÄ± (Root domain iÃ§in):**
```
Type: A
Name: @
Value: <render-ip-address>
TTL: 3600
```

### AdÄ±m 3: SSL SertifikasÄ±

Render otomatik olarak Let's Encrypt SSL sertifikasÄ± saÄŸlar. Domain doÄŸrulandÄ±ktan sonra HTTPS aktif olur.

---

## ğŸ¤– Render MCP Server

Render.com'un resmi MCP (Model Context Protocol) server'Ä±nÄ± Cursor'da kullanarak Render altyapÄ±nÄ±zÄ± doÄŸal dil komutlarÄ±yla yÃ¶netin.

### Kurulum

#### AdÄ±m 1: API Key OluÅŸturma

1. [Render Dashboard](https://dashboard.render.com) â†’ **Account Settings**
2. **API Keys** sekmesine gidin
3. **New API Key** butonuna tÄ±klayÄ±n
4. Key'e bir isim verin (Ã¶rn: "MCP Server")
5. Key'i kopyalayÄ±n ve gÃ¼venli bir yere kaydedin

**âš ï¸ Ã–nemli:** API key'i sadece bir kez gÃ¶sterilir. Kaydedin!

#### AdÄ±m 2: Cursor'da YapÄ±landÄ±rma

1. **MCP KonfigÃ¼rasyon DosyasÄ±:**
   - `.vscode/mcp.json` dosyasÄ± zaten oluÅŸturulmuÅŸ
   - API key'i eklemeniz gerekiyor

2. **API Key'i Ekle:**
   ```json
   {
     "mcpServers": {
       "render": {
         "command": "npx",
         "args": [
           "-y",
           "@render-com/mcp-server"
         ],
         "env": {
           "RENDER_API_KEY": "YOUR_API_KEY_HERE"
         }
       }
     }
   }
   ```

3. **Cursor'Ä± Yeniden BaÅŸlat:**
   - Cursor'u kapatÄ±p aÃ§Ä±n
   - MCP server otomatik olarak baÅŸlayacak

### KullanÄ±m Ã–rnekleri

```
"Render'daki tÃ¼m servislerimi listele"
"KafkasDer panel servisinin durumunu gÃ¶ster"
"Son deployment'Ä± gÃ¶ster"
"Deployment log'larÄ±nÄ± getir"
"CPU kullanÄ±mÄ±nÄ± gÃ¶ster"
"Memory kullanÄ±mÄ±nÄ± analiz et"
```

### Workspace SeÃ§imi

MCP server'Ä± kullanmadan Ã¶nce workspace'inizi seÃ§meniz gerekebilir:

```
"Set my Render workspace to kafkasder"
```

---

## ğŸ”— Webhook YapÄ±landÄ±rmasÄ±

### Webhook Endpoint

Webhook endpoint'i ÅŸu adreste mevcuttur:

```
POST /api/webhooks/render
GET  /api/webhooks/render (health check)
```

**Production URL Ã–rneÄŸi:**
```
https://your-domain.com/api/webhooks/render
```

### Render.com'da Webhook OluÅŸturma

#### AdÄ±m 1: Render Dashboard'a Git

1. [Render Dashboard](https://dashboard.render.com) â†’ Webhooks
2. "New Webhook" butonuna tÄ±kla

#### AdÄ±m 2: Webhook AyarlarÄ±

- **Name:** `KafkasDer Panel Deployments` (veya istediÄŸiniz isim)
- **URL:** `https://your-domain.com/api/webhooks/render`
- **Events:** Ä°stediÄŸiniz event'leri seÃ§in:
  - âœ… `Deploy Activated` - Deployment baÅŸarÄ±lÄ± olduÄŸunda
  - âœ… `Deploy Failed` - Deployment baÅŸarÄ±sÄ±z olduÄŸunda
  - âœ… `Deploy Live` - Deployment canlÄ±ya alÄ±ndÄ±ÄŸÄ±nda
  - âœ… `Build Ended` - Build tamamlandÄ±ÄŸÄ±nda

#### AdÄ±m 3: Secret OluÅŸtur (Opsiyonel)

GÃ¼venlik iÃ§in bir secret oluÅŸturun:

```bash
# Terminal'de random secret oluÅŸtur
openssl rand -hex 32
```

Bu secret'Ä± hem Render.com'da hem de environment variable olarak ekleyin:

```env
RENDER_WEBHOOK_SECRET=your-secret-here
```

### Event Tipleri

Webhook ÅŸu event tiplerini destekler:

**Deployment Events:**
- `deploy.activated` - Deployment aktif edildi
- `deploy.live` - Deployment canlÄ±ya alÄ±ndÄ±
- `deploy.failed` - Deployment baÅŸarÄ±sÄ±z oldu
- `deploy.created` - Yeni deployment oluÅŸturuldu
- `deploy.canceled` - Deployment iptal edildi

**Build Events:**
- `build.started` - Build baÅŸladÄ±
- `build.ended` - Build tamamlandÄ±

### Test Etme

#### Health Check

```bash
curl https://your-domain.com/api/webhooks/render
```

YanÄ±t:
```json
{
  "message": "Render webhook endpoint is active",
  "timestamp": "2025-12-26T..."
}
```

#### Webhook Test

Render.com dashboard'dan "Test Webhook" butonuna tÄ±klayarak test edebilirsiniz.

---

## ğŸ“Š Monitoring ve Logging

### Logs

1. Service â†’ **Logs** sekmesi
2. Real-time log'larÄ± gÃ¶rÃ¼ntÃ¼leyin
3. Log'larÄ± filtreleyin ve arayÄ±n

### Metrics

1. Service â†’ **Metrics** sekmesi
2. CPU, Memory, Request rate gibi metrikleri gÃ¶rÃ¼ntÃ¼leyin
3. Alert'ler ayarlayÄ±n

### Webhook Monitoring

Deployment event'lerini izlemek iÃ§in webhook endpoint'ini kullanÄ±n:
- `/api/webhooks/render` endpoint'i deployment event'lerini dinler
- Slack/Discord bildirimleri ekleyebilirsiniz

---

## ğŸ”„ CI/CD Pipeline

### GitHub Actions ile Otomatik Deploy

Render, GitHub Actions ile entegre Ã§alÄ±ÅŸÄ±r:

1. **Auto-deploy ayarlarÄ±:**
   - `autoDeployTrigger: checksPass` - CI check'leri geÃ§tikten sonra deploy
   - `autoDeployTrigger: commit` - Her commit'te deploy
   - `autoDeployTrigger: off` - Manuel deploy

2. **Branch protection:**
   - `main` branch iÃ§in `checksPass` kullanÄ±n
   - Feature branch'ler iÃ§in `commit` kullanabilirsiniz

### Preview Environments

Pull request'ler iÃ§in otomatik preview environment'lar oluÅŸturulur:

```yaml
previews:
  generation: automatic
  expireAfterDays: 7
```

---

## ğŸ› Sorun Giderme

### Build BaÅŸarÄ±sÄ±z Oluyor

1. **Log'larÄ± kontrol edin:**
   - Service â†’ **Logs** â†’ Build log'larÄ±nÄ± inceleyin

2. **YaygÄ±n sorunlar:**
   - `npm ci` hatasÄ± â†’ `package-lock.json` commit edilmiÅŸ mi?
   - TypeScript hatasÄ± â†’ `tsconfig.json` doÄŸru mu?
   - Environment variable eksik â†’ TÃ¼m gerekli deÄŸiÅŸkenler ayarlÄ± mÄ±?

### Deployment BaÅŸarÄ±sÄ±z Oluyor

1. **Pre-deploy command:**
   - `npm run db:migrate || true` - Migration hatalarÄ± deployment'Ä± durdurmaz

2. **Health check:**
   - `/` endpoint'i Ã§alÄ±ÅŸÄ±yor mu?
   - Health check timeout'u artÄ±rÄ±n

### Uygulama Ã‡alÄ±ÅŸmÄ±yor

1. **Environment variables:**
   - TÃ¼m Supabase deÄŸiÅŸkenleri doÄŸru mu?
   - `NEXT_PUBLIC_*` prefix'li deÄŸiÅŸkenler var mÄ±?

2. **Database connection:**
   - Supabase RLS politikalarÄ± doÄŸru mu?
   - Service role key doÄŸru mu?

3. **Logs:**
   - Runtime log'larÄ±nÄ± kontrol edin
   - Error mesajlarÄ±nÄ± inceleyin

### MCP Server BaÅŸlamÄ±yor

1. **API Key KontrolÃ¼:**
   - `.vscode/mcp.json` dosyasÄ±nda API key doÄŸru mu?
   - Key'in geÃ§erli olduÄŸundan emin olun

2. **Cursor Yeniden BaÅŸlatma:**
   - Cursor'u tamamen kapatÄ±p aÃ§Ä±n
   - MCP server otomatik baÅŸlamalÄ±

### Webhook Ã‡alÄ±ÅŸmÄ±yor

1. âœ… Endpoint URL'i doÄŸru mu kontrol edin
2. âœ… Environment variable'larÄ± kontrol edin
3. âœ… Server loglarÄ±nÄ± kontrol edin
4. âœ… Render.com dashboard'da webhook durumunu kontrol edin

---

## ğŸ“ˆ Scaling

### Manuel Scaling

`render.yaml` dosyasÄ±nda:
```yaml
numInstances: 2 # 2 instance Ã§alÄ±ÅŸtÄ±r
```

### Autoscaling (Professional Workspace Gerekli)

```yaml
scaling:
  minInstances: 1
  maxInstances: 5
  targetCPUPercent: 70
  targetMemoryPercent: 70
```

---

## ğŸ”’ GÃ¼venlik

1. **Environment Variables:**
   - Gizli bilgileri asla commit etmeyin
   - `sync: false` kullanarak manuel giriÅŸ yapÄ±n

2. **Secrets:**
   - `RENDER_WEBHOOK_SECRET` otomatik generate edilir
   - DiÄŸer secret'larÄ± Render Dashboard'dan ekleyin

3. **IP Allow List:**
   - Supabase'de IP whitelist ayarlayÄ±n (gerekirse)
   - Render IP'lerini ekleyin

4. **Webhook GÃ¼venliÄŸi:**
   - Production'da mutlaka `RENDER_WEBHOOK_SECRET` kullanÄ±n
   - Webhook URL'i mutlaka HTTPS olmalÄ±

---

## ğŸ“ Checklist

Deployment Ã¶ncesi kontrol listesi:

- [ ] `render.yaml` dosyasÄ± commit edildi
- [ ] TÃ¼m environment variable'lar ayarlandÄ±
- [ ] Supabase migration'larÄ± tamamlandÄ±
- [ ] Health check endpoint Ã§alÄ±ÅŸÄ±yor
- [ ] Custom domain ayarlandÄ± (opsiyonel)
- [ ] SSL sertifikasÄ± aktif
- [ ] Webhook endpoint test edildi
- [ ] Monitoring ve alert'ler ayarlandÄ±
- [ ] Render MCP server yapÄ±landÄ±rÄ±ldÄ± (opsiyonel)

---

## ğŸ”— FaydalÄ± Linkler

- [Render Documentation](https://render.com/docs)
- [Render Blueprint Reference](https://render.com/docs/blueprint-spec)
- [Next.js on Render](https://render.com/docs/deploy-nextjs)
- [Render MCP Documentation](https://render.com/docs/mcp-server)
- [Render API Documentation](https://api-docs.render.com)
- [Model Context Protocol](https://modelcontextprotocol.io)

---

**Son GÃ¼ncelleme:** 26 AralÄ±k 2025

